
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TASTO X PRO - Fix Mobile</title>
    <style>
        :root { --bg: #0f0f0f; --accent: #00ff88; --panel: #1a1a1a; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: white; display: flex; flex-direction: column; height: 100vh; }
        
        /* Header compatto */
        header { padding: 10px; background: #000; font-size: 14px; text-align: center; border-bottom: 2px solid var(--accent); }

        /* Area Foto Massimizzata */
        #viewer { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #000; overflow: hidden; }
        canvas { max-width: 100%; max-height: 100%; touch-action: none; }

        /* Pannello Comandi Mobile Friendly */
        .controls { background: var(--panel); padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full-width { grid-column: span 2; }
        
        .btn { background: #333; color: white; border: 1px solid #555; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: bold; width: 100%; }
        .btn-upload { background: var(--accent); color: black; }
        
        select { background: #2a2a2a; color: white; border: 1px solid var(--accent); padding: 12px; border-radius: 8px; width: 100%; font-size: 14px; }
        label { display: block; font-size: 10px; color: var(--accent); margin-bottom: 4px; text-transform: uppercase; }
    </style>
</head>
<body>

<header>TASTO X | Laboratorio Professionale</header>

<div id="viewer">
    <canvas id="canvas"></canvas>
</div>

<div class="controls">
    <div class="full-width">
        <button class="btn btn-upload" onclick="document.getElementById('upload').click()">SCATTA O CARICA FOTO</button>
        <input type="file" id="upload" accept="image/*" style="display:none">
    </div>

    <div>
        <label>Colore Facciata</label>
        <select id="color-muro" onchange="applyRendering()">
            <option value="">Seleziona RAL...</option>
            <option value="120,129,133">RAL 7000</option>
            <option value="164,146,129">RAL 1019</option>
            <option value="60,60,60">RAL 7016</option>
        </select>
    </div>

    <div>
        <label>Colore Cornici</label>
        <select id="color-cornice" onchange="applyRendering()">
            <option value="">Seleziona RAL...</option>
            <option value="241,236,225">RAL 9010</option>
            <option value="30,84,109">RAL 5009</option>
        </select>
    </div>

    <button class="btn" onclick="reset()">RESET</button>
    <button class="btn" onclick="save()">SALVA RISULTATO</button>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    let originalData = null;

    document.getElementById('upload').onchange = function(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                originalData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    function applyRendering() {
        if (!originalData) return;
        const cMuro = document.getElementById('color-muro').value.split(',');
        const cCornice = document.getElementById('color-cornice').value.split(',');

        const current = new ImageData(new Uint8ClampedArray(originalData.data), originalData.width, originalData.height);
        const d = current.data;

        for (let i = 0; i < d.length; i += 4) {
            const lux = (0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2]) / 255;
            
            // Logica Avanzata: se il pixel è molto chiaro è probabilmente una cornice/marmo
            const isBright = (d[i] > 170 && d[i+1] > 170 && d[i+2] > 170);

            if (isBright && cCornice.length > 1) {
                d[i] = cCornice[0] * lux; d[i+1] = cCornice[1] * lux; d[i+2] = cCornice[2] * lux;
            } else if (!isBright && cMuro.length > 1) {
                d[i] = cMuro[0] * lux; d[i+1] = cMuro[1] * lux; d[i+2] = cMuro[2] * lux;
            }
        }
        ctx.putImageData(current, 0, 0);
    }

    function reset() { if(originalData) ctx.putImageData(originalData, 0, 0); }
    function save() { window.open(canvas.toDataURL()); }
</script>
</body>
</html>
