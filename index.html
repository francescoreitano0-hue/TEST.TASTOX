<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TASTO X - PRO HD</title>
    <style>
        :root { --accent: #00ff88; --bg: #000; --ui-panel: #1a1a1a; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER FISSO */
        .top-bar { height: 60px; padding: 10px; background: var(--ui-panel); display: flex; gap: 8px; border-bottom: 2px solid var(--accent); z-index: 100; }
        
        /* AREA LAVORO BOXATA */
        #viewport { flex: 1; position: relative; display: flex; overflow: hidden; background: #0a0a0a; border: 1px solid #333; }
        
        /* ZOOM LATERALE FISSO */
        .zoom-panel { width: 50px; background: var(--ui-panel); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; border-right: 1px solid #333; }
        .zoom-slider { appearance: slider-vertical; width: 25px; height: 180px; cursor: pointer; }

        /* CONTENITORE FOTO CON SCROLL (PAN) */
        #canvas-container { flex: 1; overflow: auto; position: relative; display: flex; align-items: flex-start; justify-content: flex-start; }
        canvas { cursor: crosshair; transform-origin: 0 0; background-color: #111; }

        /* FOOTER FISSO (SMARTPHONE OK) */
        .bottom-bar { padding: 12px; background: var(--ui-panel); border-top: 2px solid #333; z-index: 100; }
        .btn { flex: 1; padding: 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; text-transform: uppercase; }
        .btn-camera { background: var(--accent); color: black; }
        .btn-action { background: #333; color: white; border: 1px solid #555; }
        
        .mode-selector { display: flex; gap: 5px; margin-bottom: 10px; background: #000; padding: 4px; border-radius: 6px; }
        .m-btn { flex: 1; padding: 10px; border: none; border-radius: 4px; background: #222; color: #777; font-size: 11px; font-weight: bold; }
        .m-btn.active { background: var(--accent); color: black; }

        .ral-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        select { width: 100%; padding: 10px; background: #2a2a2a; color: white; border: 1px solid var(--accent); border-radius: 6px; }
        label { font-size: 9px; color: var(--accent); margin-bottom: 3px; display: block; }
    </style>
</head>
<body>

<div class="top-bar">
    <button class="btn btn-camera" onclick="document.getElementById('capture').click()">SCATTA FOTO HD</button>
    <input type="file" id="capture" accept="image/*" capture="environment" style="display:none">
    
    <button class="btn btn-action" onclick="document.getElementById('upload').click()">CARICA</button>
    <input type="file" id="upload" accept="image/*" style="display:none">
    
    <button class="btn btn-action" onclick="undo()">ANNULLA</button>
</div>

<div id="main-container" style="display:flex; flex:1; overflow:hidden;">
    <div class="zoom-panel">
        <span style="font-size:18px">+</span>
        <input type="range" id="zoom" class="zoom-slider" min="0.5" max="4" step="0.1" value="1">
        <span style="font-size:18px">-</span>
    </div>
    
    <div id="canvas-container">
        <canvas id="canvas"></canvas>
    </div>
</div>

<div class="bottom-bar">
    <div class="mode-selector">
        <button id="mode-facciata" class="m-btn active" onclick="setMode('facciata')">MODO: FACCIATA</button>
        <button id="mode-cornice" class="m-btn" onclick="setMode('cornice')">MODO: CORNICE</button>
    </div>

    <div class="ral-row">
        <div>
            <label>RAL FACCIATA</label>
            <select id="ral-f">
                <option value="120,129,133">RAL 7000</option>
                <option value="164,146,129">RAL 1019</option>
                <option value="60,60,60">RAL 7016</option>
                <option value="232,226,204">RAL 1013</option>
            </select>
        </div>
        <div>
            <label>RAL CORNICE</label>
            <select id="ral-c">
                <option value="241,236,225">RAL 9010</option>
                <option value="232,226,204">RAL 1013</option>
                <option value="30,84,109">RAL 5009</option>
            </select>
        </div>
    </div>
    
    <button class="btn btn-action" style="width:100%; margin-top:10px; background:#444;" onclick="save()">SALVA PROGETTO</button>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', {willReadFrequently: true});
    const zoomSlider = document.getElementById('zoom');
    const container = document.getElementById('canvas-container');
    
    let originalData = null;
    let history = [];
    let currentMode = 'facciata';

    // Gestione Caricamento/Scatto
    [document.getElementById('capture'), document.getElementById('upload')].forEach(el => {
        el.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    originalData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    history = [ctx.getImageData(0, 0, canvas.width, canvas.height)];
                    zoomSlider.value = 1;
                    applyZoom();
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        };
    });

    function setMode(m) {
        currentMode = m;
        document.getElementById('mode-facciata').classList.toggle('active', m === 'facciata');
        document.getElementById('mode-cornice').classList.toggle('active', m === 'cornice');
    }

    zoomSlider.oninput = applyZoom;
    function applyZoom() {
        const s = zoomSlider.value;
        canvas.style.transform = `scale(${s})`;
    }

    // CLICK PER COLORARE (PRECISO CON ZOOM)
    canvas.onclick = (e) => {
        if(!originalData) return;
        const rect = canvas.getBoundingClientRect();
        const s = zoomSlider.value;
        const x = Math.round((e.clientX - rect.left) / s);
        const y = Math.round((e.clientY - rect.top) / s);
        
        const val = currentMode === 'facciata' ? document.getElementById('ral-f').value : document.getElementById('ral-c').value;
        const rgb = val.split(',').map(Number);
        
        processFill(x, y, rgb);
    };

    function processFill(startX, startY, fillColor) {
        const currentData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = currentData.data;
        const w = canvas.width;
        const stack = [[startX, startY]];
        const startPos = (startY * w + startX) * 4;
        const sR = data[startPos], sG = data[startPos+1], sB = data[startPos+2];
        const visited = new Uint8Array(w * canvas.height);

        while (stack.length) {
            const [x, y] = stack.pop();
            const idx = y * w + x;
            if (x < 0 || x >= w || y < 0 || y >= canvas.height || visited[idx]) continue;
            visited[idx] = 1;

            const pos = idx * 4;
            const diff = Math.abs(data[pos]-sR) + Math.abs(data[pos+1]-sG) + Math.abs(data[pos+2]-sB);

            if (diff < 65) {
                const lum = (0.299 * originalData.data[pos] + 0.587 * originalData.data[pos+1] + 0.114 * originalData.data[pos+2]) / 255;
                data[pos] = fillColor[0] * lum;
                data[pos+1] = fillColor[1] * lum;
                data[pos+2] = fillColor[2] * lum;
                stack.push([x+1, y], [x-1, y], [x, y+1], [x, y-1]);
            }
        }
        ctx.putImageData(currentData, 0, 0);
        history.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
    }

    function undo() {
        if (history.length > 1) {
            history.pop();
            ctx.putImageData(history[history.length - 1], 0, 0);
        }
    }

    function save() {
        const link = document.createElement('a');
        link.download = 'progetto_frcolor.png';
        link.href = canvas.toDataURL("image/png", 1.0);
        link.click();
    }
</script>
</body>
</html>
