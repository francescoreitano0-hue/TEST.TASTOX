<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FR COLOR - FULL RAL & SEARCH</title>
    <style>
        :root { --accent: #00ff88; --bg: #000; }
        * { box-sizing: border-box; touch-action: pan-x pan-y; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        .header { height: 55px; background: #1a1a1a; display: flex; padding: 8px; gap: 8px; border-bottom: 2px solid var(--accent); z-index: 30; }
        .btn { flex: 1; border: none; border-radius: 4px; font-weight: bold; font-size: 11px; cursor: pointer; text-transform: uppercase; background: #333; color: white; }
        .btn-main { background: var(--accent); color: black; }

        /* AREA LAVORO (STILE SPETTROMETRO) */
        #main { flex: 1; position: relative; overflow: hidden; background: #080808; display: flex; }
        
        .side-zoom { width: 45px; background: #111; display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid #333; z-index: 20; }
        .slider { appearance: slider-vertical; width: 20px; height: 180px; }

        #viewport { flex: 1; overflow: auto; display: flex; align-items: center; justify-content: center; background-image: radial-gradient(#222 1px, transparent 1px); background-size: 20px 20px; }
        canvas { transform-origin: center center; display: block; cursor: crosshair; }

        /* FOOTER CON RICERCA RAL */
        .footer { height: 165px; background: #1a1a1a; padding: 10px; border-top: 2px solid #333; z-index: 30; display: flex; flex-direction: column; gap: 8px; }
        
        .mode-row { display: flex; gap: 8px; }
        .m-btn { flex: 1; padding: 10px; border: none; border-radius: 4px; background: #222; color: #555; font-size: 10px; font-weight: bold; }
        .m-btn.active { background: var(--accent); color: black; }

        .search-container { position: relative; }
        .search-input { width: 100%; background: #2a2a2a; color: white; border: 1px solid var(--accent); padding: 10px; border-radius: 4px; font-size: 14px; outline: none; }
        
        .ral-display { display: flex; align-items: center; gap: 10px; background: #111; padding: 5px 10px; border-radius: 4px; font-size: 12px; height: 35px; }
        .color-preview { width: 25px; height: 25px; border-radius: 3px; border: 1px solid #555; }
        
        .save-btn { background: #444; color: white; padding: 10px; border: none; border-radius: 4px; font-weight: bold; font-size: 11px; }
    </style>
</head>
<body>

<div class="header">
    <button class="btn btn-main" onclick="document.getElementById('c').click()">SCATTA HD</button>
    <input type="file" id="c" accept="image/*" capture="environment" style="display:none">
    <button class="btn" onclick="document.getElementById('u').click()">CARICA</button>
    <input type="file" id="u" accept="image/*" style="display:none">
    <button class="btn" onclick="undo()">BACK</button>
</div>

<div id="main">
    <div class="side-zoom">
        <span style="font-weight:bold">+</span>
        <input type="range" id="z" class="slider" min="0.1" max="4" step="0.1" value="1">
        <span style="font-weight:bold">-</span>
    </div>
    <div id="viewport">
        <canvas id="canvas"></canvas>
    </div>
</div>

<div class="footer">
    <div class="mode-row">
        <button id="bmf" class="m-btn active" onclick="setM('f')">FACCIATA</button>
        <button id="bmc" class="m-btn" onclick="setM('c')">CORNICE</button>
    </div>
    
    <div class="search-container">
        <input type="text" id="ralSearch" class="search-input" placeholder="Cerca RAL (es. 7016)..." oninput="findRal(this.value)">
    </div>

    <div class="ral-display">
        <div id="prev-col" class="color-preview" style="background: #788185;"></div>
        <span id="ral-name">Selezionato: RAL 7000</span>
    </div>

    <button class="save-btn" onclick="save()">SALVA PROGETTO</button>
</div>

<script>
    // DATABASE RAL CLASSIC COMPLETO
    const RAL_DB = {
        "1000":[205,186,136],"1001":[208,176,132],"1002":[210,170,109],"1003":[249,168,0],"1004":[228,158,0],"1005":[203,142,0],"1006":[226,144,0],"1007":[232,140,0],"1011":[175,128,79],"1012":[221,175,39],"1013":[232,226,204],"1014":[225,198,153],"1015":[230,210,181],"1016":[241,221,56],"1017":[246,169,80],"1018":[250,202,48],"1019":[164,146,129],"1020":[158,151,100],"1021":[242,182,0],"1023":[247,181,0],"1024":[186,143,76],"1027":[161,122,0],"1028":[255,155,0],"1032":[226,163,0],"1033":[249,154,28],"1034":[235,156,82],"2000":[218,110,0],"2001":[186,72,27],"2002":[191,33,30],"2003":[246,120,40],"2004":[226,83,0],"2008":[237,107,33],"2009":[222,79,0],"2010":[216,92,45],"2011":[236,124,0],"2012":[213,101,77],"3000":[167,41,32],"3001":[155,36,35],"3002":[147,33,34],"3003":[134,26,34],"3004":[107,28,35],"3005":[89,25,31],"3007":[65,30,32],"3009":[109,52,45],"3011":[121,36,35],"3012":[199,134,117],"3013":[154,39,35],"3014":[211,110,112],"3015":[216,160,166],"3016":[163,53,41],"3017":[203,85,93],"3018":[199,63,74],"3020":[193,18,28],"3022":[207,105,91],"3027":[180,32,54],"3031":[172,52,56],"4001":[141,92,123],"4002":[140,54,67],"4003":[210,83,131],"4004":[105,23,45],"4005":[100,94,157],"4006":[149,39,114],"4007":[74,32,54],"4008":[138,73,129],"4009":[157,134,146],"4010":[198,30,116],"5000":[47,79,124],"5001":[31,71,94],"5002":[32,49,130],"5003":[31,47,78],"5004":[30,31,38],"5005":[30,76,142],"5007":[62,107,145],"5008":[38,48,56],"5009":[30,84,109],"5010":[14,67,121],"5011":[30,38,51],"5012":[37,141,200],"5013":[35,43,72],"5014":[96,111,140],"5015":[34,118,172],"5017":[6,93,153],"5018":[13,136,136],"5019":[27,85,131],"5020":[1,72,78],"5021":[7,117,119],"5022":[37,40,80],"5023":[69,101,139],"5024":[96,144,170],"6000":[51,115,95],"6001":[41,105,52],"6002":[50,91,48],"6003":[78,85,69],"6004":[1,68,71],"6005":[17,66,50],"6006":[61,61,54],"6007":[43,48,39],"6008":[48,46,39],"6009":[33,48,40],"6010":[69,121,55],"6011":[108,124,89],"6012":[40,52,52],"6013":[119,115,82],"6014":[71,69,57],"6015":[59,62,60],"6016":[1,121,90],"6017":[77,142,68],"6018":[87,171,60],"6019":[181,209,170],"6020":[55,67,51],"6021":[135,154,124],"6022":[43,41,35],"6024":[1,132,84],"6025":[93,123,58],"6026":[1,95,78],"6027":[121,190,181],"6028":[46,89,74],"6029":[1,111,59],"6032":[35,127,83],"6033":[69,139,130],"6034":[123,179,183],"7000":[120,129,133],"7001":[140,150,157],"7002":[129,125,103],"7003":[122,125,114],"7004":[150,153,154],"7005":[100,102,101],"7006":[117,111,99],"7008":[116,106,73],"7009":[85,88,83],"7010":[87,90,85],"7011":[83,89,94],"7012":[89,96,101],"7013":[85,81,71],"7015":[79,83,88],"7016":[60,66,72],"7021":[47,50,53],"7022":[76,75,70],"7023":[125,129,122],"7024":[71,74,78],"7026":[47,54,58],"7030":[144,146,139],"7031":[91,104,112],"7032":[180,180,170],"7033":[124,130,119],"7034":[143,140,119],"7035":[197,199,196],"7036":[151,147,150],"7037":[122,123,122],"7038":[180,182,180],"7039":[107,105,99],"7040":[152,158,162],"7042":[141,146,149],"7043":[78,82,82],"7044":[183,181,171],"7045":[141,146,150],"7046":[129,134,138],"7047":[199,200,199],"8000":[134,111,63],"8001":[147,97,42],"8002":[113,71,48],"8003":[122,81,41],"8004":[137,63,45],"8007":[103,63,38],"8008":[111,76,34],"8011":[90,52,36],"8012":[102,46,41],"8014":[73,56,43],"8015":[93,44,36],"8016":[72,41,36],"8017":[69,45,39],"8019":[61,54,53],"8022":[26,23,24],"8023":[164,87,46],"8024":[121,80,63],"8025":[117,88,72],"8028":[81,58,45],"9001":[233,227,211],"9002":[214,213,203],"9003":[236,236,231],"9004":[40,40,42],"9005":[14,14,16],"9010":[241,236,225],"9011":[39,41,43],"9016":[241,244,240],"9017":[30,30,31],"9018":[201,210,206]
    };

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', {willReadFrequently: true});
    const z = document.getElementById('z');
    const view = document.getElementById('viewport');
    let ori = null, hist = [], mode = 'f';
    let currentFacciata = [120, 129, 133]; // Default RAL 7000
    let currentCornice = [232, 226, 204];  // Default RAL 1013

    // CARICAMENTO FOTO
    const load = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                ori = ctx.getImageData(0,0,canvas.width,canvas.height);
                hist = [ctx.getImageData(0,0,canvas.width,canvas.height)];
                z.value = 1; 
                applyZ();
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };
    document.getElementById('c').onchange = load;
    document.getElementById('u').onchange = load;

    function setM(m) {
        mode = m;
        document.getElementById('bmf').classList.toggle('active', m === 'f');
        document.getElementById('bmc').classList.toggle('active', m === 'c');
    }

    // ZOOM
    z.oninput = applyZ;
    function applyZ() { canvas.style.transform = `scale(${z.value})`; }

    // RICERCA RAL
    function findRal(val) {
        if(RAL_DB[val]) {
            const col = RAL_DB[val];
            if(mode === 'f') currentFacciata = col;
            else currentCornice = col;
            
            document.getElementById('prev-col').style.background = `rgb(${col[0]},${col[1]},${col[2]})`;
            document.getElementById('ral-name').innerText = `Selezionato: RAL ${val}`;
        }
    }

    // MOTORE COLORE (Spettrometro Style)
    canvas.onclick = (e) => {
        if(!ori) return;
        const rect = canvas.getBoundingClientRect();
        const s = z.value;
        const x = Math.round((e.clientX - rect.left) / s);
        const y = Math.round((e.clientY - rect.top) / s);
        const col = mode === 'f' ? currentFacciata : currentCornice;
        
        const img = ctx.getImageData(0,0,canvas.width,canvas.height);
        const d = img.data, w = canvas.width, h = canvas.height;
        const stack = [[x, y]];
        const p = (y*w+x)*4;
        const sR = d[p], sG = d[p+1], sB = d[p+2];
        const vis = new Uint8Array(w * h);

        while(stack.length) {
            const [cx, cy] = stack.pop();
            const i = cy*w+cx;
            if(cx<0||cx>=w||cy<0||cy>=h||vis[i]) continue;
            vis[i]=1;
            const pos = i*4;
            if(Math.abs(d[pos]-sR)+Math.abs(d[pos+1]-sG)+Math.abs(d[pos+2]-sB) < 65) {
                const lum = (0.299*ori.data[pos]+0.587*ori.data[pos+1]+0.114*ori.data[pos+2])/255;
                d[pos]=col[0]*lum; d[pos+1]=col[1]*lum; d[pos+2]=col[2]*lum;
                stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
            }
        }
        ctx.putImageData(img,0,0);
        hist.push(ctx.getImageData(0,0,canvas.width,canvas.height));
    };

    function undo() { if(hist.length > 1) { hist.pop(); ctx.putImageData(hist[hist.length-1],0,0); } }
    function save() { const l = document.createElement('a'); l.download='progetto.png'; l.href=canvas.toDataURL(); l.click(); }
</script>
</body>
</html>
