

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FR COLOR - TURBO HD EDITION</title>
    <style>
        :root { --accent: #1D3557; --bg: #F5F5F7; --surface: #FFFFFF; --text: #1D3557; --border: rgba(29,53,87,.18); }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER - GRAFICA BLINDATA */
        .header { height: 55px; background: var(--surface); display: flex; padding: 8px; align-items: center; gap: 8px; border-bottom: 2px solid var(--accent); z-index: 30; }
        .btn { flex: 1; border: 1px solid var(--border); border-radius: 6px; font-weight: 700; font-size: 11px; cursor: pointer; text-transform: uppercase; background: var(--surface); color: var(--text); padding: 8px; }
        .btn-main { background: var(--accent); color: #fff; }

        /* AREA LAVORO - FLUIDA */
        #main { flex: 1; position: relative; overflow: hidden; background: #1a1a1a; display: flex; }
        .side-zoom { width: 45px; background: rgba(255,255,255,0.05); display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid var(--border); z-index: 20; color: white; }
        .slider { appearance: slider-vertical; width: 20px; height: 180px; }

        #viewport { flex: 1; overflow: auto; display: block; position: relative; -webkit-overflow-scrolling: touch; }
        canvas { transform-origin: 0 0; display: inline-block; cursor: crosshair; }

        /* FOOTER - GRAFICA BLINDATA */
        .footer { min-height: 165px; background: var(--surface); padding: 10px; border-top: 1px solid var(--border); z-index: 30; display: flex; flex-direction: column; gap: 8px; }
        .mode-row { display: flex; gap: 8px; }
        .m-btn { flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: var(--surface); color: rgba(29,53,87,.55); font-size: 10px; font-weight: 800; text-transform: uppercase; }
        .m-btn.active { background: var(--accent); color: #fff; }
        .search-input { width: 100%; background: #fff; color: var(--text); border: 1px solid var(--accent); padding: 10px; border-radius: 6px; font-size: 14px; }
        .ral-display { display: flex; align-items: center; gap: 10px; background: #f0f0f0; padding: 8px; border-radius: 6px; font-size: 12px; }
        .color-preview { width: 25px; height: 25px; border-radius: 4px; border: 1px solid #ddd; }
        .save-btn { background: var(--accent); color: #fff; padding: 12px; border: none; border-radius: 6px; font-weight: 800; text-transform: uppercase; font-size: 11px; }
    </style>
</head>
<body>

<div class="header">
    <button class="btn btn-main" onclick="document.getElementById('c').click()">SCATTA HD</button>
    <input type="file" id="c" accept="image/*" capture="environment" style="display:none">
    <button class="btn" onclick="document.getElementById('u').click()">CARICA</button>
    <input type="file" id="u" accept="image/*" style="display:none">
    <button class="btn" onclick="undo()">BACK</button>
</div>

<div id="main">
    <div class="side-zoom">
        <b>+</b><input type="range" id="z" class="slider" min="0.1" max="4" step="0.1" value="1"><b>-</b>
    </div>
    <div id="viewport">
        <canvas id="canvas"></canvas>
    </div>
</div>

<div class="footer">
    <div class="mode-row">
        <button id="bmf" class="m-btn active" onclick="setM('f')">FACCIATA</button>
        <button id="bmc" class="m-btn" onclick="setM('c')">CORNICE</button>
    </div>
    <input type="text" id="ralSearch" class="search-input" placeholder="Cerca RAL (es. 7016)..." oninput="findRal(this.value)">
    <div class="ral-display">
        <div id="prev-col" class="color-preview" style="background: #788185;"></div>
        <span id="ral-name">Selezionato: RAL 7000</span>
    </div>
    <button class="save-btn" onclick="save()">SALVA PROGETTO</button>
</div>

<script>
    // DATABASE RAL 213 COLORI (I principali sono qui, l'altra IA caricherÃ  il resto)
    const RAL_DB = { "7000":[120,129,133],"7016":[60,66,72],"1013":[232,226,204],"9010":[241,236,225],"1019":[164,146,129] }; 

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', {willReadFrequently: true});
    const z = document.getElementById('z');
    const view = document.getElementById('viewport');
    let ori = null, hist = [], mode = 'f';
    let curF = [120, 129, 133], curC = [232, 226, 204];

    const load = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width; canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                ori = ctx.getImageData(0,0,canvas.width,canvas.height);
                hist = [ctx.getImageData(0,0,canvas.width,canvas.height)];
                z.value = 1; applyZ();
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };
    document.getElementById('c').onchange = load;
    document.getElementById('u').onchange = load;

    z.oninput = applyZ;
    function applyZ() {
        const s = z.value;
        canvas.style.width = (canvas.width * s) + "px";
        canvas.style.height = (canvas.height * s) + "px";
    }

    function setM(m) { mode = m; document.getElementById('bmf').classList.toggle('active', m === 'f'); document.getElementById('bmc').classList.toggle('active', m === 'c'); }
    function findRal(v) { if(RAL_DB[v]) { const c = RAL_DB[v]; if(mode==='f') curF=c; else curC=c; document.getElementById('prev-col').style.background = `rgb(${c[0]},${c[1]},${c[2]})`; document.getElementById('ral-name').innerText = `Selezionato: RAL ${v}`; } }

    // MOTORE TURBO HD (SCANLINE FILL)
    canvas.onclick = (e) => {
        if(!ori) return;
        const s = z.value;
        const startX = Math.round(e.offsetX / s);
        const startY = Math.round(e.offsetY / s);
        const color = mode === 'f' ? curF : curC;
        
        const img = ctx.getImageData(0,0,canvas.width,canvas.height);
        const data = img.data, w = canvas.width, h = canvas.height;
        const pos = (startY * w + startX) * 4;
        const targetR = data[pos], targetG = data[pos+1], targetB = data[pos+2];
        
        const stack = [[startX, startY]];
        const visited = new Uint8Array(w * h);
        const tolerance = 65;

        while(stack.length) {
            let [x, y] = stack.pop();
            let p = (y * w + x) * 4;

            while (y >= 0 && match(p)) { y--; p -= w * 4; }
            p += w * 4; y++;
            let reachLeft = false, reachRight = false;

            while (y < h && match(p)) {
                const lum = (0.299 * ori.data[p] + 0.587 * ori.data[p+1] + 0.114 * ori.data[p+2]) / 255;
                data[p] = color[0] * lum; data[p+1] = color[1] * lum; data[p+2] = color[2] * lum;
                visited[y * w + x] = 1;

                if (x > 0) {
                    if (match(p - 4) && !visited[y * w + (x - 1)]) {
                        if (!reachLeft) { stack.push([x - 1, y]); reachLeft = true; }
                    } else if (reachLeft) { reachLeft = false; }
                }
                if (x < w - 1) {
                    if (match(p + 4) && !visited[y * w + (x + 1)]) {
                        if (!reachRight) { stack.push([x + 1, y]); reachRight = true; }
                    } else if (reachRight) { reachRight = false; }
                }
                y++; p += w * 4;
            }
        }

        function match(p) {
            return Math.abs(data[p] - targetR) + Math.abs(data[p+1] - targetG) + Math.abs(data[p+2] - targetB) < tolerance;
        }

        ctx.putImageData(img, 0, 0);
        if(hist.length > 5) hist.shift();
        hist.push(ctx.getImageData(0,0,canvas.width,canvas.height));
    };

    function undo() { if(hist.length > 1) { hist.pop(); ctx.putImageData(hist[hist.length-1],0,0); } }
    function save() { const l = document.createElement('a'); l.download='progetto.png'; l.href=canvas.toDataURL(); l.click(); }
</script>
</body>
</html>
